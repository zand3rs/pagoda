<html>
<head>
    <link rel="stylesheet" type="text/css" href="css/popcorn.css"/>
    <script src="js/jquery.min.js"></script>
    <script src="js/popcorn.js"></script>
    <script src="js/zip/zip.js"></script>

    <script>
    //-------------------------------------------------------------------------
    //-------------------------------------------------------------------------

    var host = 'http://localhost/~zander/popcorn';
    var activeUser = null;
    var userDir = null;

    //-------------------------------------------------------------------------

    function strPad(i,l,s) {
        var o = i.toString();
        if (!s) { s = '0'; }
        while (o.length < l) {
            o = s + o;
        }
        return o;
    }

    //-------------------------------------------------------------------------
    //-------------------------------------------------------------------------

    function onerror(message) {
        $("#flash").html('ERROR: ' + message + '<br>');
    }

    //-------------------------------------------------------------------------
    //-------------------------------------------------------------------------

    var bookmarks = new Array();

    //-------------------------------------------------------------------------

    function getActiveUser() {
        var app_url = host + '/users/getActiveUser';

        $.get(app_url, function(data) {
            if (data && data.id) {
                activeUser = data;
                userDir = activeUser ? strPad(activeUser.id, 10) : '.';
            }
        }, 'json');
    }

    //-------------------------------------------------------------------------

    function downloadBookmark(id) {
        $("#flash").html($("#flash").html() + 'bookmarks: ' + JSON.stringify(bookmarks) + '<br>');
        for (var i in bookmarks) {
            var bookmark = bookmarks[i];
            if (id == bookmark.id && bookmark.archive) {
                var url = host + bookmark.archive;
                var dest_dir = popcorn.dirname(bookmark.archive);
                var index = bookmark.local_path;
                $("#flash").html($("#flash").html() + 'download dest_dir: ' + dest_dir + '<br>');

                /*
                popcorn.deleteFolder(dest_dir, function(msg) {
                    $("#flash").html($("#flash").html() + 'deleteFolder: ' + msg + '<br>');
                }, onerror);
                */

                popcorn.download(url, dest_dir, function(fpath) {
                    $("#flash").html($("#flash").html() + 'download successful: ' + fpath + '<br>');
                    popcorn.extract(fpath, dest_dir, function(fpath) {
                        $("#flash").html($("#flash").html() + 'extract successful: ' + fpath + '<br>');
                        popcorn.getFsUrl(index, function(url) {
                            $("#flash").html($("#flash").html() + 'index: ' + url + '<br>');
                        });
                    }, onerror);
                }, onerror);

                /*
                popcorn.readFileAsText(index, function(data) {
                    var baseurl = 'filesystem:http://localhost/temporary/files/0000000001/91618313efc8ebe404680d6b00f81b50/';
                    var regex = /(href|src)( *= *)(['"])([^'"]*)(['"])/g;
                    var out = data.replace(regex, "$1$2$3" + baseurl + "$4$5");
                    $("#flash").html($("#flash").html() + 'data: ' + out + '<br>');
                }, onerror);
                */

                /*
                popcorn.readFileAsText(index, function(data) {
                    var baseurl = 'filesystem:http://localhost/temporary/files/0000000001/91618313efc8ebe404680d6b00f81b50/';
                    var regex = /(href|src)( *= *)(['"])([^'"]*)(['"])/g;
                    var regex1 = /(href)( *= *)(['"])(?!https?:\/\/|\/\/)([^'"]*)(['"])/g;
                    var regex2 = /(src)( *= *)(['"])(?!https?:\/\/|\/\/)([^'"]*)(['"])/;
                    //var out = data.replace(regex1, "$1$2$3" + baseurl + "$4$5");
                        //out = out.replace(regex2, "$1$2$3" + baseurl + "$4$5");
                    data = data.replace(regex, "$1$2$3" + baseurl + "$4$5");
                    $("#flash").html($("#flash").html() + 'data: ' + data + '<br>');
                }, onerror);
                */
            }
        }
    }

    //-------------------------------------------------------------------------

    function showBookmarks() {
        var app_url = host + '/bookmarks/get_all';
        $.get(app_url, function(data) {
                $.each(data, function(key, val) {
                    var bookmark = val.Bookmark;
                    bookmarks.push(bookmark);

                    popcorn.getFsUrl(bookmark.local_path, function(url) {
                        var bookmarksHtml = (url)
                            ? "<div><a href='" + url + "' target='_blank'>" + bookmark.title + "</a></div>"
                            : "<div><a href='javascript:downloadBookmark(" + bookmark.id + ")'>" + bookmark.title + "</a></div>";
                        $('#bookmarks').html($('#bookmarks').html() + bookmarksHtml);
                    });

                    /*
                    var bookmarksHtml = "<div><a href='javascript:downloadBookmark(" + bookmark.id + ")'>" + bookmark.title + "</a></div>";
                    $('#bookmarks').html($('#bookmarks').html() + bookmarksHtml);
                    */
                });
        }, 'json');
    }

    //-------------------------------------------------------------------------

    function addBookmark(title, url) {
        var app_url = host + '/bookmarks/save';
        var dataObj = {
             Bookmark: {
                 title: title,
                 url: url
             }
        };
        var payload = JSON.stringify(dataObj);

        $.ajax({
            type: 'POST',
            contentType: 'application/json',
            processData: false,
            dataType: 'json',
            timeout: 60000,
            url: app_url,
            data: payload
        })
        .success(function(data, textStatus, jqXHR) {
                })
        .error(function(jqXHR, textStatus, errorThrown) {
                })
        .complete(function(jqXHR, textStatus) {
                window.close();
                });

    }

    //-------------------------------------------------------------------------

    $(document).ready(function() {
        //getActiveUser();
        showBookmarks();

        $("#add-bookmark").click(function() {
            chrome.tabs.getSelected(null, function(tab) {
                addBookmark(tab.title, tab.url);
                });
            });

        /*
        popcorn.test(function(msg) {
            $("#flash").html($("#flash").html() + 'test: ' + msg + '<br>');
        });
        */

        popcorn.initialize(onerror);

    });
    </script>
</head>

<body>
    <div id="action"><button id="add-bookmark">Add Bookmark</button></div>
    <hr>
    <div id="flash"></div>
    <div id="bookmarks"></div>
    <div id="filelist"></div>
</body>
</html>
