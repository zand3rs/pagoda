<html>
<head>
    <link rel="stylesheet" type="text/css" href="css/popcorn.css"/>
    <script src="js/jquery.min.js"></script>
    <script src="js/popcorn.js"></script>
    <script src="js/popcorn_api.js"></script>
    <script src="js/zip/zip.js"></script>

    <script>
    //-------------------------------------------------------------------------
    //-------------------------------------------------------------------------

    var host = 'http://localhost/~zander/popcorn';
    var bookmarks = new Array();

    //-------------------------------------------------------------------------
    //-------------------------------------------------------------------------

    function setFlash(msg, append) {
        var message = (append) ? $("#flash").html() + '<br>' : '';
            message += msg;
        $("#flash").html(message);
    }

    //-------------------------------------------------------------------------

    function onerror(msg) {
        setFlash('ERROR: ' + msg);
    }

    //-------------------------------------------------------------------------
    //-------------------------------------------------------------------------

    function downloadBookmark(id) {
        setFlash('bookmarks: ' + JSON.stringify(bookmarks), true);

        for (var i in bookmarks) {
            var bookmark = bookmarks[i];
            if (id == bookmark.id && bookmark.archive) {
                var url = host + bookmark.archive;
                var dest_dir = popcorn.dirname(bookmark.archive);
                var index = bookmark.local_path;

                setFlash('download dest_dir: ' + dest_dir, true);

                popcorn.download(url, dest_dir, function(fpath) {
                    setFlash('download successful: ' + fpath, true);
                    popcorn.extract(fpath, dest_dir, function(fpath) {
                        setFlash('extract successful: ' + fpath, true);
                        popcorn.getFsUrl(index, function(url) {
                            setFlash('index: ' + url, true);
                        });
                    }, onerror);
                }, onerror);
            }
        }
    }

    //-------------------------------------------------------------------------

    function showBookmarks() {
        popcorn_api.getBookmarks(function(my_bookmarks) {
            bookmarks = my_bookmarks;
            $.each(bookmarks, function(key, val) {
                var bookmark = val;
                popcorn.getFsUrl(bookmark.local_path, function(url) {
                    var bookmarksHtml = (url)
                        ? "<div><a href='" + url + "' target='_blank'>" + bookmark.title + "</a></div>"
                        : "<div><a href='javascript:downloadBookmark(" + bookmark.id + ")'>" + bookmark.title + "</a></div>";
                    $('#bookmarks').html($('#bookmarks').html() + bookmarksHtml);
                });
            });
        });
    }

    //-------------------------------------------------------------------------

    function initHandlers() {
        $("#add-bookmark").click(function() {
            chrome.tabs.getSelected(null, function(tab) {
                popcorn_api.addBookmark(tab.title, tab.url);
                });
            });
    }

    //-------------------------------------------------------------------------
    //-------------------------------------------------------------------------

    $(document).ready(function() {
        popcorn_api.initialize({"host": host});
        popcorn.initialize(onerror);

        initHandlers();
        showBookmarks();
    });

    //-------------------------------------------------------------------------
    //-------------------------------------------------------------------------
    </script>
</head>

<body>
    <div id="action"><button id="add-bookmark">Add Bookmark</button></div>
    <hr>
    <div id="flash"></div>
    <div id="bookmarks"></div>
    <div id="filelist"></div>
</body>
</html>
