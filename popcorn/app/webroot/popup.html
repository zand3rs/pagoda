<html>
<head>
    <link rel="stylesheet" type="text/css" href="css/popcorn.css"/>
    <script src="js/jquery.min.js"></script>
    <script src="js/jquery.md5.js"></script>
    <script src="js/popcorn.js"></script>
    <script src="js/popcorn_api.js"></script>
    <script src="js/zip/zip.js"></script>

    <script>
    //-------------------------------------------------------------------------
    //-------------------------------------------------------------------------

    var host = 'http://localhost/~zander/popcorn';
    var bookmarks_dirty = false;

    var POPCORN_PATH = {
        root          : '/popcorn',
        bookmarks_sig : '/bookmarks_sig',
        bookmarks     : '/bookmarks'
    }

    //-------------------------------------------------------------------------
    //-------------------------------------------------------------------------

    function setFlash(msg, append) {
        var message = (append) ? $("#flash").html() : '';
            message += msg + '<br>';
        $("#flash").html(message);
    }

    //-------------------------------------------------------------------------

    function onError(msg) {
        setFlash('ERROR: ' + msg);
    }

    //-------------------------------------------------------------------------
    //-------------------------------------------------------------------------

    function getStoragePath(fpath) {
        var user_dir = popcorn.strPad(1, 10);
        var storage_path = POPCORN_PATH.root + '/' + user_dir + fpath;
        return storage_path;
    }

    //-------------------------------------------------------------------------

    function getBookmarksSig(onend) {
        var fpath = getStoragePath(POPCORN_PATH.bookmarks_sig);
        console.log('getBookmarksSig: fpath: ' + fpath);

        popcorn.readFileAsText(fpath, function(data) {
            var bookmarksig = data;
            onend(bookmarksig);
        }, function(msg) {
            console.log('getBookmarksSig: ' + msg);
            onend('')
        });
    }

    //-------------------------------------------------------------------------

    function getBookmarks(onend) {
        var bookmarks_path = getStoragePath(POPCORN_PATH.bookmarks);
        var bookmarksig_path = getStoragePath(POPCORN_PATH.bookmarks_sig);

        function _getBookmarks() {
            popcorn_api.getBookmarks(function(bookmarks) {
                if (bookmarks.length > 0) {
                    var data = JSON.stringify(bookmarks);
                    var data_sig = $.md5(data);

                    console.log('popcorn_api.getBookmarks: data: ' + data);
                    popcorn.saveAs(bookmarks_path, data);
                    popcorn.saveAs(bookmarksig_path, data_sig, function(msg) {
                        console.log('getBookmarks: error: ' + msg);
                    });
                }
                onend(bookmarks);
            });
        }

        popcorn.readFileAsText(bookmarks_path, function(data) {
            var bookmarks = JSON.parse(data);
            onend(bookmarks);
        }, function() {
            _getBookmarks();
        });
    }

    //-------------------------------------------------------------------------

    function verifyBookmarksSig() {
        var bookmarks_path = getStoragePath(POPCORN_PATH.bookmarks);
        var bookmarksig_path = getStoragePath(POPCORN_PATH.bookmarks_sig);

        popcorn_api.getBookmarks(function(bookmarks) {
            var data = JSON.stringify(bookmarks);
            var data_sig = $.md5(data);

            getBookmarksSig(function(sig) {
                console.log('sig: ' + sig);
                if (sig != data_sig) {
                    console.log('data_sig:' + data_sig);
                    popcorn.deleteFile(bookmarks_path, function() {
                        console.log('file deleted: ' + bookmarks_path);
                    }, function() {
                        console.log('delete error: ' + bookmarks_path);
                        //console.log();
                    });

                    popcorn.deleteFile(bookmarksig_path, function() {
                        console.log('file deleted: ' + bookmarksig_path);
                    }, function() {
                        console.log('delete error: ' + bookmarksig_path);
                        //console.log();
                    });
                }
            });
        }, function() {
            //console.log();
        });
    }

    //-------------------------------------------------------------------------

    function downloadBookmark(id) {
        getBookmarks(function(bookmarks) {
            for (var i in bookmarks) {
                var bookmark = bookmarks[i];
                if (id == bookmark.id && bookmark.archive) {
                    var url = popcorn_api.getResourceURL(bookmark.archive);
                    var dest_dir = popcorn.dirname(bookmark.archive);
                    var index = bookmark.local_path;

                    console.log('download dest_dir: ' + dest_dir);

                    popcorn.download(url, dest_dir, function(fpath) {
                        console.log('download successful: ' + fpath);
                        popcorn.extract(fpath, dest_dir, function(fpath) {
                            console.log('extract successful: ' + fpath);
                            popcorn.getFsUrl(index, function(url) {
                                console.log('index: ' + url);
                            });
                        }, onError);
                    }, onError);
                }
            }
        });
    }

    //-------------------------------------------------------------------------

    function showBookmarks() {
        getBookmarks(function(bookmarks) {
            $.each(bookmarks, function(key, val) {
                var bookmark = val;
                popcorn.getFsUrl(bookmark.local_path, function(url) {
                    //var bookmarksHtml = (url)
                    //    ? "<div><a href='" + url + "' target='_blank'>" + bookmark.title + "</a></div>"
                    //    : "<div><a href='javascript:downloadBookmark(" + bookmark.id + ")'>" + bookmark.title + "</a></div>";
                    var bookmarksHtml = "<div><a href='javascript:downloadBookmark(" + bookmark.id + ")'>" + bookmark.title + "</a></div>";
                    $('#bookmarks').html($('#bookmarks').html() + bookmarksHtml);
                });
            });
        });
    }

    //-------------------------------------------------------------------------

    function initHandlers() {
        $("#add-bookmark").click(function() {
            chrome.tabs.getSelected(null, function(tab) {
                popcorn_api.addBookmark(tab.title, tab.url);
            });
        });
    }

    //-------------------------------------------------------------------------

    function doBackground() {
        verifyBookmarksSig();
    }

    //-------------------------------------------------------------------------
    //-------------------------------------------------------------------------

    $(document).ready(function() {
        popcorn_api.initialize({"host": host});
        popcorn.initialize(function() {
            initHandlers();
            showBookmarks();
            doBackground();
        }, onError);
    });

    //-------------------------------------------------------------------------
    //-------------------------------------------------------------------------
    </script>
</head>

<body>
    <div id="action"><button id="add-bookmark">Add Bookmark</button></div>
    <hr>
    <div id="flash"></div>
    <div id="bookmarks"></div>
    <div id="filelist"></div>
</body>
</html>
